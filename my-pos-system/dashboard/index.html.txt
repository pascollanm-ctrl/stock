<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard & Reporting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding-top: 70px;
        }

        /* Navigation Bar */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            height: 70px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo i {
            margin-right: 10px;
            color: #3498db;
        }

        .nav-links {
            display: flex;
            list-style: none;
        }

        .nav-links li {
            margin-left: 2rem;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .nav-links a i {
            margin-right: 8px;
        }

        .nav-links a:hover, .nav-links a.active {
            background-color: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.2rem;
            display: flex;
            align-items: center;
        }

        .header h1 i {
            margin-right: 15px;
            color: #3498db;
        }

        /* Filters Section */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .filter-group label i {
            margin-right: 8px;
            color: #3498db;
        }

        .filter-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .filter-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .btn-export {
            background-color: #9b59b6;
            color: white;
        }

        .btn-export:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }

        .btn i {
            margin-right: 8px;
        }

        /* Metrics Cards */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .sales-icon { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .profit-icon { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .transactions-icon { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .avg-icon { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

        .metric-title {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0.5rem 0;
        }

        .metric-change {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #27ae60;
        }

        .metric-change.negative {
            color: #e74c3c;
        }

        .metric-change i {
            margin-right: 5px;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-header h3 {
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .chart-header h3 i {
            margin-right: 10px;
            color: #3498db;
        }

        /* Custom Chart Styles */
        .bar-chart {
            display: flex;
            align-items: flex-end;
            height: 300px;
            padding: 20px 0;
            border-bottom: 2px solid #eee;
            position: relative;
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            padding: 0 10px;
        }

        .bar {
            width: 60%;
            background: linear-gradient(to top, #3498db, #2980b9);
            border-radius: 6px 6px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-label {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .y-axis {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            border-right: 1px solid #eee;
        }

        .y-tick {
            position: absolute;
            right: 5px;
            font-size: 0.8rem;
            color: #95a5a6;
        }

        .pie-chart {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            position: relative;
        }

        .pie-segment {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            clip-path: polygon(50% 50%, 100% 50%, 100% 100%, 50% 50%);
            transform-origin: 50% 50%;
        }

        .segment-1 { background: #3498db; }
        .segment-2 { background: #2ecc71; }
        .segment-3 { background: #e74c3c; }
        .segment-4 { background: #f39c12; }
        .segment-5 { background: #9b59b6; }

        .pie-center {
            position: absolute;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #2c3e50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .pie-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Transactions Table */
        .transactions-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-header h3 {
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        .section-header h3 i {
            margin-right: 10px;
            color: #3498db;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        thead {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: #555;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background-color: #f9f9f9;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .completed { background-color: #d5f4e6; color: #27ae60; }
        .pending { background-color: #fdebd0; color: #f39c12; }
        .cancelled { background-color: #fadbd8; color: #e74c3c; }

        .amount {
            font-weight: 600;
        }

        .positive-amount { color: #27ae60; }
        .negative-amount { color: #e74c3c; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            color: #ddd;
        }

        .empty-state h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #95a5a6;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            color: #7f8c8d;
        }

        .loading i {
            font-size: 2rem;
            margin-right: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 1rem;
            }
            
            .nav-links {
                font-size: 0.9rem;
            }
            
            .nav-links li {
                margin-left: 1rem;
            }
            
            .container {
                padding: 1.5rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 1rem;
            }
            
            .filters-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .filter-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                min-width: 100%;
            }
        }

        @media (max-width: 576px) {
            .navbar {
                flex-direction: column;
                height: auto;
                padding: 1rem;
            }
            
            .nav-links {
                margin-top: 1rem;
                width: 100%;
                justify-content: space-between;
            }
            
            .nav-links li {
                margin-left: 0;
            }
            
            body {
                padding-top: 120px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-chart-line"></i>
            <span>Sales Dashboard</span>
        </div>
        <ul class="nav-links">
            <li><a href="../stock/index.html"><i class="fas fa-boxes"></i> Stock</a></li>
            <li><a href="../billing/index.html"><i class="fas fa-cash-register"></i> Billing</a></li>
            <li><a href="index.html" class="active"><i class="fas fa-chart-line"></i> Dashboard</a></li>
        </ul>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-bar"></i> Sales Dashboard & Reporting</h1>
            <div class="filter-actions">
                <button class="btn btn-export" id="exportBtn">
                    <i class="fas fa-file-export"></i> Export CSV
                </button>
                <button class="btn btn-secondary" id="printReportBtn">
                    <i class="fas fa-print"></i> Print Report
                </button>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filter-group">
                <label for="dateFrom"><i class="fas fa-calendar-alt"></i> From Date</label>
                <input type="date" id="dateFrom" class="filter-control">
            </div>
            
            <div class="filter-group">
                <label for="dateTo"><i class="fas fa-calendar-alt"></i> To Date</label>
                <input type="date" id="dateTo" class="filter-control">
            </div>
            
            <div class="filter-group">
                <label for="categoryFilter"><i class="fas fa-filter"></i> Category</label>
                <select id="categoryFilter" class="filter-control">
                    <option value="all">All Categories</option>
                    <option value="electronics">Electronics</option>
                    <option value="clothing">Clothing</option>
                    <option value="food">Food</option>
                    <option value="furniture">Furniture</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button class="btn btn-primary" id="applyFiltersBtn">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
            </div>
        </div>

        <!-- Metrics Cards -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Total Sales</div>
                        <div class="metric-value" id="totalSales">$0.00</div>
                    </div>
                    <div class="metric-icon sales-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="metric-change positive" id="salesChange">
                    <i class="fas fa-arrow-up"></i> 0% from previous period
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Total Profit</div>
                        <div class="metric-value" id="totalProfit">$0.00</div>
                    </div>
                    <div class="metric-icon profit-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="metric-change positive" id="profitChange">
                    <i class="fas fa-arrow-up"></i> 0% from previous period
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Transactions</div>
                        <div class="metric-value" id="transactionsCount">0</div>
                    </div>
                    <div class="metric-icon transactions-icon">
                        <i class="fas fa-receipt"></i>
                    </div>
                </div>
                <div class="metric-change positive" id="transactionsChange">
                    <i class="fas fa-arrow-up"></i> 0% from previous period
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Average Transaction</div>
                        <div class="metric-value" id="avgTransaction">$0.00</div>
                    </div>
                    <div class="metric-icon avg-icon">
                        <i class="fas fa-calculator"></i>
                    </div>
                </div>
                <div class="metric-change positive" id="avgTransactionChange">
                    <i class="fas fa-arrow-up"></i> 0% from previous period
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i> Sales by Day</h3>
                </div>
                <div class="bar-chart" id="salesChart">
                    <div class="y-axis" id="yAxis">
                        <!-- Y-axis labels will be generated by JavaScript -->
                    </div>
                    <!-- Bar chart will be generated by JavaScript -->
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-pie"></i> Sales by Category</h3>
                </div>
                <div class="pie-chart" id="categoryChart">
                    <div class="pie-center">
                        <span id="totalChartValue">$0</span>
                    </div>
                    <!-- Pie segments will be generated by JavaScript -->
                </div>
                <div class="pie-legend" id="categoryLegend">
                    <!-- Legend will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="transactions-section">
            <div class="section-header">
                <h3><i class="fas fa-list-alt"></i> Recent Transactions</h3>
                <div class="summary-value" id="tableSummary">Showing 0 transactions</div>
            </div>
            
            <div class="table-container">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Date & Time</th>
                            <th>Items</th>
                            <th>Subtotal</th>
                            <th>Discount</th>
                            <th>Tax</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                        <!-- Transactions will be loaded here -->
                    </tbody>
                </table>
                
                <!-- Loading State -->
                <div id="loadingState" class="loading">
                    <i class="fas fa-spinner"></i>
                    <span>Loading transactions...</span>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-receipt"></i>
                    <h3>No Transactions Found</h3>
                    <p>No sales data available for the selected filters.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database and state variables
        let db;
        let salesData = [];
        let filteredData = [];
        let previousPeriodData = [];
        
        // DOM Elements
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const categoryFilter = document.getElementById('categoryFilter');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const exportBtn = document.getElementById('exportBtn');
        const printReportBtn = document.getElementById('printReportBtn');
        
        // Metrics elements
        const totalSalesElement = document.getElementById('totalSales');
        const totalProfitElement = document.getElementById('totalProfit');
        const transactionsCountElement = document.getElementById('transactionsCount');
        const avgTransactionElement = document.getElementById('avgTransaction');
        const salesChangeElement = document.getElementById('salesChange');
        const profitChangeElement = document.getElementById('profitChange');
        const transactionsChangeElement = document.getElementById('transactionsChange');
        const avgTransactionChangeElement = document.getElementById('avgTransactionChange');
        
        // Chart elements
        const salesChart = document.getElementById('salesChart');
        const categoryChart = document.getElementById('categoryChart');
        const categoryLegend = document.getElementById('categoryLegend');
        const totalChartValue = document.getElementById('totalChartValue');
        const yAxis = document.getElementById('yAxis');
        
        // Table elements
        const transactionsBody = document.getElementById('transactionsBody');
        const tableSummary = document.getElementById('tableSummary');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initDB();
            setupEventListeners();
            setDefaultDates();
            loadSalesData();
        });

        // Initialize IndexedDB
        function initDB() {
            const request = indexedDB.open('posDB', 2);
            
            request.onerror = (event) => {
                console.error('Database error:', event.target.error);
                alert('Failed to open database. Please check if your browser supports IndexedDB.');
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database initialized successfully');
            };
        }

        // Set up event listeners
        function setupEventListeners() {
            // Filter buttons
            applyFiltersBtn.addEventListener('click', applyFilters);
            exportBtn.addEventListener('click', exportToCSV);
            printReportBtn.addEventListener('click', printReport);
            
            // Set today as default end date
            const today = new Date().toISOString().split('T')[0];
            dateTo.value = today;
            
            // Set default start date (30 days ago)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            dateFrom.value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        // Set default date ranges
        function setDefaultDates() {
            const today = new Date();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(today.getDate() - 7);
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(today.getMonth() - 1);
            
            dateFrom.value = oneMonthAgo.toISOString().split('T')[0];
            dateTo.value = today.toISOString().split('T')[0];
        }

        // Load sales data from IndexedDB
        function loadSalesData() {
            const transaction = db.transaction(['sales'], 'readonly');
            const salesStore = transaction.objectStore('sales');
            const request = salesStore.getAll();
            
            request.onsuccess = (event) => {
                salesData = event.target.result || [];
                console.log(`Loaded ${salesData.length} sales records`);
                
                // Also load stock data for profit calculation
                loadStockDataForProfit();
            };
            
            request.onerror = (event) => {
                console.error('Error loading sales data:', event.target.error);
                alert('Failed to load sales data from database.');
                hideLoading();
            };
        }

        // Load stock data for profit calculation
        function loadStockDataForProfit() {
            const transaction = db.transaction(['stock'], 'readonly');
            const stockStore = transaction.objectStore('stock');
            const request = stockStore.getAll();
            
            request.onsuccess = (event) => {
                const stockData = event.target.result || [];
                
                // Enrich sales data with cost information for profit calculation
                salesData = salesData.map(sale => {
                    const enrichedItems = sale.items.map(item => {
                        const stockItem = stockData.find(s => s.barcode === item.barcode);
                        return {
                            ...item,
                            costPrice: stockItem ? stockItem.costPrice : 0
                        };
                    });
                    
                    // Calculate profit for each sale
                    const profit = enrichedItems.reduce((sum, item) => {
                        const itemProfit = (item.price - item.costPrice) * item.quantity;
                        return sum + itemProfit;
                    }, 0);
                    
                    return {
                        ...sale,
                        items: enrichedItems,
                        profit: profit
                    };
                });
                
                applyFilters();
                hideLoading();
            };
            
            request.onerror = (event) => {
                console.error('Error loading stock data:', event.target.error);
                // Continue without profit data
                applyFilters();
                hideLoading();
            };
        }

        // Hide loading state
        function hideLoading() {
            loadingState.style.display = 'none';
        }

        // Apply filters to data
        function applyFilters() {
            loadingState.style.display = 'flex';
            emptyState.style.display = 'none';
            
            const fromDate = dateFrom.value ? new Date(dateFrom.value) : null;
            const toDate = dateTo.value ? new Date(dateTo.value) : null;
            const selectedCategory = categoryFilter.value;
            
            // Adjust toDate to include the entire day
            if (toDate) {
                toDate.setHours(23, 59, 59, 999);
            }
            
            // Filter data
            filteredData = salesData.filter(sale => {
                const saleDate = new Date(sale.date);
                
                // Date filter
                if (fromDate && saleDate < fromDate) return false;
                if (toDate && saleDate > toDate) return false;
                
                // Category filter
                if (selectedCategory !== 'all') {
                    // Check if any item in the sale belongs to the selected category
                    const hasCategoryItem = sale.items.some(item => {
                        // We need to get item category from stock data
                        // For now, we'll assume all items are in the sale data
                        return item.category === selectedCategory;
                    });
                    
                    if (!hasCategoryItem) return false;
                }
                
                return true;
            });
            
            // Calculate previous period data for comparison
            calculatePreviousPeriodData(fromDate, toDate);
            
            // Update UI
            updateMetrics();
            updateCharts();
            updateTransactionsTable();
            hideLoading();
        }

        // Calculate previous period data for comparison
        function calculatePreviousPeriodData(fromDate, toDate) {
            if (!fromDate || !toDate) {
                previousPeriodData = [];
                return;
            }
            
            const periodDuration = toDate - fromDate;
            const previousFromDate = new Date(fromDate.getTime() - periodDuration);
            const previousToDate = new Date(toDate.getTime() - periodDuration);
            
            previousPeriodData = salesData.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate >= previousFromDate && saleDate <= previousToDate;
            });
        }

        // Update metrics display
        function updateMetrics() {
            // Calculate metrics for current period
            const totalSales = filteredData.reduce((sum, sale) => sum + sale.total, 0);
            const totalProfit = filteredData.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            const transactionsCount = filteredData.length;
            const avgTransaction = transactionsCount > 0 ? totalSales / transactionsCount : 0;
            
            // Calculate metrics for previous period
            const prevTotalSales = previousPeriodData.reduce((sum, sale) => sum + sale.total, 0);
            const prevTotalProfit = previousPeriodData.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            const prevTransactionsCount = previousPeriodData.length;
            const prevAvgTransaction = prevTransactionsCount > 0 ? prevTotalSales / prevTransactionsCount : 0;
            
            // Calculate percentage changes
            const salesChange = prevTotalSales > 0 ? ((totalSales - prevTotalSales) / prevTotalSales) * 100 : 0;
            const profitChange = prevTotalProfit > 0 ? ((totalProfit - prevTotalProfit) / prevTotalProfit) * 100 : 0;
            const transactionsChange = prevTransactionsCount > 0 ? ((transactionsCount - prevTransactionsCount) / prevTransactionsCount) * 100 : 0;
            const avgTransactionChange = prevAvgTransaction > 0 ? ((avgTransaction - prevAvgTransaction) / prevAvgTransaction) * 100 : 0;
            
            // Update metric values
            totalSalesElement.textContent = `$${totalSales.toFixed(2)}`;
            totalProfitElement.textContent = `$${totalProfit.toFixed(2)}`;
            transactionsCountElement.textContent = transactionsCount;
            avgTransactionElement.textContent = `$${avgTransaction.toFixed(2)}`;
            
            // Update change indicators
            updateChangeIndicator(salesChangeElement, salesChange);
            updateChangeIndicator(profitChangeElement, profitChange);
            updateChangeIndicator(transactionsChangeElement, transactionsChange);
            updateChangeIndicator(avgTransactionChangeElement, avgTransactionChange);
            
            // Update table summary
            tableSummary.textContent = `Showing ${filteredData.length} transactions`;
        }

        // Update change indicator with appropriate styling
        function updateChangeIndicator(element, change) {
            const absChange = Math.abs(change).toFixed(1);
            
            if (change > 0) {
                element.className = 'metric-change positive';
                element.innerHTML = `<i class="fas fa-arrow-up"></i> ${absChange}% from previous period`;
            } else if (change < 0) {
                element.className = 'metric-change negative';
                element.innerHTML = `<i class="fas fa-arrow-down"></i> ${absChange}% from previous period`;
            } else {
                element.className = 'metric-change';
                element.innerHTML = `<i class="fas fa-minus"></i> 0% from previous period`;
            }
        }

        // Update sales chart
        function updateCharts() {
            updateSalesChart();
            updateCategoryChart();
        }

        // Update sales bar chart
        function updateSalesChart() {
            // Clear existing chart
            salesChart.innerHTML = '';
            yAxis.innerHTML = '';
            
            // Group sales by day
            const salesByDay = {};
            filteredData.forEach(sale => {
                const saleDate = new Date(sale.date);
                const dateKey = saleDate.toISOString().split('T')[0];
                const displayDate = saleDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                if (!salesByDay[displayDate]) {
                    salesByDay[displayDate] = {
                        date: displayDate,
                        fullDate: dateKey,
                        total: 0
                    };
                }
                
                salesByDay[displayDate].total += sale.total;
            });
            
            // Convert to array and sort by date
            const chartData = Object.values(salesByDay)
                .sort((a, b) => new Date(a.fullDate) - new Date(b.fullDate))
                .slice(-7); // Show last 7 days
            
            if (chartData.length === 0) {
                salesChart.innerHTML = '<div class="empty-state" style="padding: 50px 20px; color: #7f8c8d;">No sales data available for the selected period.</div>';
                return;
            }
            
            // Find maximum value for scaling
            const maxValue = Math.max(...chartData.map(d => d.total));
            const chartHeight = 250; // Fixed chart height in pixels
            
            // Create Y-axis labels
            const yTicks = 5;
            for (let i = 0; i <= yTicks; i++) {
                const value = (maxValue / yTicks) * (yTicks - i);
                const tick = document.createElement('div');
                tick.className = 'y-tick';
                tick.style.top = `${(chartHeight / yTicks) * i - 10}px`;
                tick.textContent = `$${value.toFixed(0)}`;
                yAxis.appendChild(tick);
            }
            
            salesChart.appendChild(yAxis);
            
            // Create bars
            chartData.forEach(data => {
                const barHeight = (data.total / maxValue) * chartHeight;
                
                const barGroup = document.createElement('div');
                barGroup.className = 'bar-group';
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}px`;
                bar.title = `$${data.total.toFixed(2)}`;
                
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = `$${data.total.toFixed(0)}`;
                
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = data.date;
                
                bar.appendChild(barValue);
                barGroup.appendChild(bar);
                barGroup.appendChild(barLabel);
                salesChart.appendChild(barGroup);
            });
        }

        // Update category pie chart
        function updateCategoryChart() {
            // Clear existing chart and legend
            categoryChart.innerHTML = '';
            categoryLegend.innerHTML = '';
            
            // Group sales by category
            const salesByCategory = {
                electronics: 0,
                clothing: 0,
                food: 0,
                furniture: 0,
                other: 0
            };
            
            // Count items by category in all sales
            filteredData.forEach(sale => {
                sale.items.forEach(item => {
                    const category = item.category || 'other';
                    if (salesByCategory.hasOwnProperty(category)) {
                        salesByCategory[category] += item.price * item.quantity;
                    } else {
                        salesByCategory.other += item.price * item.quantity;
                    }
                });
            });
            
            // Filter out categories with zero sales
            const chartData = Object.entries(salesByCategory)
                .filter(([category, value]) => value > 0)
                .map(([category, value]) => ({ category, value }));
            
            if (chartData.length === 0) {
                totalChartValue.textContent = '$0';
                categoryChart.innerHTML = '<div style="text-align: center; padding: 50px 20px; color: #7f8c8d;">No category data available.</div>';
                return;
            }
            
            // Calculate total for percentage calculations
            const totalValue = chartData.reduce((sum, item) => sum + item.value, 0);
            totalChartValue.textContent = `$${totalValue.toFixed(0)}`;
            
            // Calculate cumulative percentage for pie chart
            let cumulativeAngle = 0;
            const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
            
            chartData.forEach((item, index) => {
                const percentage = (item.value / totalValue) * 100;
                const angle = (percentage / 100) * 360;
                
                // Create pie segment
                const segment = document.createElement('div');
                segment.className = `pie-segment segment-${index + 1}`;
                segment.style.transform = `rotate(${cumulativeAngle}deg)`;
                segment.style.clipPath = `polygon(50% 50%, ${50 + 50 * Math.cos(angle * Math.PI / 180)}% ${50 - 50 * Math.sin(angle * Math.PI / 180)}%, 50% 50%)`;
                segment.title = `${item.category}: $${item.value.toFixed(2)} (${percentage.toFixed(1)}%)`;
                
                categoryChart.appendChild(segment);
                cumulativeAngle += angle;
                
                // Create legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const legendColor = document.createElement('div');
                legendColor.className = 'legend-color';
                legendColor.style.backgroundColor = colors[index % colors.length];
                
                const legendText = document.createElement('span');
                legendText.textContent = `${item.category.charAt(0).toUpperCase() + item.category.slice(1)}: $${item.value.toFixed(2)} (${percentage.toFixed(1)}%)`;
                
                legendItem.appendChild(legendColor);
                legendItem.appendChild(legendText);
                categoryLegend.appendChild(legendItem);
            });
            
            // Add center circle
            const centerCircle = document.createElement('div');
            centerCircle.className = 'pie-center';
            centerCircle.innerHTML = `<span id="totalChartValue">$${totalValue.toFixed(0)}</span>`;
            categoryChart.appendChild(centerCircle);
        }

        // Update transactions table
        function updateTransactionsTable() {
            transactionsBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Sort by date (newest first)
            const sortedData = [...filteredData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only recent transactions (last 20)
            const recentTransactions = sortedData.slice(0, 20);
            
            recentTransactions.forEach(sale => {
                const row = document.createElement('tr');
                const saleDate = new Date(sale.date);
                const formattedDate = saleDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Count unique items
                const itemCount = sale.items.reduce((count, item) => count + item.quantity, 0);
                const uniqueItems = sale.items.length;
                
                row.innerHTML = `
                    <td><strong>${sale.transactionId}</strong></td>
                    <td>${formattedDate}</td>
                    <td>${uniqueItems} items (${itemCount} units)</td>
                    <td class="amount">$${sale.subtotal.toFixed(2)}</td>
                    <td class="amount negative-amount">-$${sale.discount.toFixed(2)}</td>
                    <td class="amount">$${sale.tax.toFixed(2)}</td>
                    <td class="amount positive-amount">$${sale.total.toFixed(2)}</td>
                `;
                
                transactionsBody.appendChild(row);
            });
        }

        // Export data to CSV
        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No data to export.');
                return;
            }
            
            // Prepare CSV headers
            const headers = ['Transaction ID', 'Date', 'Items Count', 'Units Sold', 'Subtotal', 'Discount', 'Tax', 'Total', 'Profit'];
            
            // Prepare CSV rows
            const rows = filteredData.map(sale => {
                const saleDate = new Date(sale.date);
                const formattedDate = saleDate.toLocaleDateString('en-US');
                const itemCount = sale.items.reduce((count, item) => count + item.quantity, 0);
                const uniqueItems = sale.items.length;
                
                return [
                    sale.transactionId,
                    formattedDate,
                    uniqueItems,
                    itemCount,
                    sale.subtotal.toFixed(2),
                    sale.discount.toFixed(2),
                    sale.tax.toFixed(2),
                    sale.total.toFixed(2),
                    (sale.profit || 0).toFixed(2)
                ];
            });
            
            // Combine headers and rows
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.join(','))
            ].join('\n');
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('CSV file downloaded successfully!');
        }

        // Print report
        function printReport() {
            // Create a printable version of the report
            const printWindow = window.open('', '_blank');
            const printDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Calculate summary for print
            const totalSales = filteredData.reduce((sum, sale) => sum + sale.total, 0);
            const totalProfit = filteredData.reduce((sum, sale) => sum + (sale.profit || 0), 0);
            const transactionsCount = filteredData.length;
            const avgTransaction = transactionsCount > 0 ? totalSales / transactionsCount : 0;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sales Report - ${printDate}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
                        .report-header { margin-bottom: 30px; }
                        .report-date { color: #7f8c8d; margin-bottom: 20px; }
                        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
                        .metric { background: #f8f9fa; padding: 15px; border-radius: 8px; }
                        .metric-title { color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; }
                        .metric-value { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #f8f9fa; font-weight: bold; }
                        .positive { color: #27ae60; }
                        .negative { color: #e74c3c; }
                        .summary { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
                        @media print {
                            body { margin: 0; padding: 10px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>Sales Dashboard Report</h1>
                        <div class="report-date">
                            <strong>Date Range:</strong> ${dateFrom.value} to ${dateFrom.value === dateTo.value ? '' : dateTo.value}<br>
                            <strong>Report Date:</strong> ${printDate}<br>
                            <strong>Category Filter:</strong> ${categoryFilter.options[categoryFilter.selectedIndex].text}
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-title">Total Sales</div>
                            <div class="metric-value">$${totalSales.toFixed(2)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-title">Total Profit</div>
                            <div class="metric-value">$${totalProfit.toFixed(2)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-title">Transactions</div>
                            <div class="metric-value">${transactionsCount}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-title">Average Transaction</div>
                            <div class="metric-value">$${avgTransaction.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <h3>Recent Transactions (${Math.min(filteredData.length, 20)} of ${filteredData.length})</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Date</th>
                                <th>Items</th>
                                <th>Subtotal</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredData.slice(0, 20).map(sale => {
                                const saleDate = new Date(sale.date);
                                const formattedDate = saleDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const itemCount = sale.items.reduce((count, item) => count + item.quantity, 0);
                                const uniqueItems = sale.items.length;
                                
                                return `
                                    <tr>
                                        <td>${sale.transactionId}</td>
                                        <td>${formattedDate}</td>
                                        <td>${uniqueItems} items (${itemCount} units)</td>
                                        <td>$${sale.subtotal.toFixed(2)}</td>
                                        <td class="positive">$${sale.total.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="summary">
                        <p><strong>Report Summary:</strong></p>
                        <p>This report covers ${filteredData.length} transactions from ${dateFrom.value} to ${dateTo.value}.</p>
                        <p>Total Sales Volume: $${totalSales.toFixed(2)} | Total Profit: $${totalProfit.toFixed(2)}</p>
                        <p>Average Transaction Value: $${avgTransaction.toFixed(2)}</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <p><em>Report generated by StockMaster Pro POS System</em></p>
                        <button onclick="window.print()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Print Report
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                            Close
                        </button>
                    </div>
                    
                    <script>
                        window.onload = function() {
                            window.print();
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
    </script>
</body>
</html>